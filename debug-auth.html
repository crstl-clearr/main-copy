<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Google Auth - EcoSlug Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .debug-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .auth-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }
        .auth-button:hover {
            background: #3367d6;
        }
        .auth-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .google-icon {
            width: 18px;
            height: 18px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .user-profile {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            background: #f9f9f9;
            display: none;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }
        .user-email {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>EcoSlug Tracker - Google Auth Debug</h1>
    
    <div class="debug-section">
        <h2>üîß Debug Information</h2>
        <p><strong>Current Time:</strong> <span id="currentTime"></span></p>
        <p><strong>Google API Status:</strong> <span id="gapiStatus">Loading...</span></p>
        <p><strong>Auth Service Status:</strong> <span id="authServiceStatus">Loading...</span></p>
        <p><strong>Console Messages:</strong> Check browser console (F12) for detailed logs</p>
    </div>

    <div class="debug-section">
        <h2>üîë Authentication Test</h2>
        
        <div id="authContainer">
            <button class="auth-button" id="googleSignInBtn" onclick="testSignIn()" disabled>
                <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon" onerror="this.style.display='none'">
                <span>Sign in with Google</span>
            </button>
            
            <div id="authStatus" class="status info">
                Initializing Google authentication...
            </div>
            
            <div id="userProfile" class="user-profile">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div>
                        <div id="userName" class="user-name"></div>
                        <div id="userEmail" class="user-email"></div>
                    </div>
                </div>
                <button class="auth-button" id="googleSignOutBtn" onclick="testSignOut()" style="background: #dc3545;">
                    Sign Out
                </button>
            </div>
        </div>
    </div>

    <div class="debug-section">
        <h2>üß™ Manual Tests</h2>
        <button onclick="checkGoogleAPI()">Check Google API</button>
        <button onclick="checkAuthService()">Check Auth Service</button>
        <button onclick="testNetworkConnection()">Test Network</button>
        <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="debug-section">
        <h2>üìä Status Log</h2>
        <div id="statusLog" style="background: white; padding: 10px; height: 200px; overflow-y: auto; border: 1px solid #ddd; font-family: monospace; font-size: 12px;"></div>
    </div>

    <!-- Load the authentication service -->
    <script src="js/auth.js"></script>
    
    <script>
        let logCounter = 0;
        
        // Initialize debug page
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            log('Debug page loaded');
            checkInitialization();
        });

        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
        }

        function log(message, type = 'info') {
            logCounter++;
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('statusLog');
            const logEntry = `[${timestamp}] ${logCounter}: ${message}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[Auth Debug] ${message}`);
        }

        function updateStatus(elementId, message, className = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${className}`;
            }
        }

        // Check if Google API and Auth Service are initializing
        function checkInitialization() {
            let attempts = 0;
            
            const checkLoop = () => {
                attempts++;
                log(`Initialization check attempt ${attempts}`);
                
                // Check Google API
                if (typeof gapi !== 'undefined') {
                    updateStatus('gapiStatus', 'Google API loaded ‚úì', 'success');
                    document.getElementById('gapiStatus').textContent = 'Google API loaded ‚úì';
                } else {
                    document.getElementById('gapiStatus').textContent = `Loading... (${attempts}/20)`;
                }
                
                // Check Auth Service
                if (typeof googleAuthService !== 'undefined') {
                    updateStatus('authServiceStatus', 'Auth Service loaded ‚úì', 'success');
                    document.getElementById('authServiceStatus').textContent = 'Auth Service loaded ‚úì';
                    
                    if (googleAuthService.isInitialized) {
                        updateStatus('authStatus', 'Google authentication ready ‚úì', 'success');
                        document.getElementById('googleSignInBtn').disabled = false;
                        log('Google Auth fully initialized');
                        googleAuthService.updateUserInterface();
                        return;
                    } else {
                        updateStatus('authStatus', 'Connecting to Google...', 'info');
                    }
                } else {
                    document.getElementById('authServiceStatus').textContent = `Loading... (${attempts}/20)`;
                }
                
                if (attempts < 20) {
                    setTimeout(checkLoop, 1000);
                } else {
                    log('Initialization timeout after 20 seconds', 'error');
                    updateStatus('authStatus', 'Google authentication failed to initialize ‚ùå', 'error');
                    updateStatus('gapiStatus', 'Failed to load ‚ùå', 'error');
                    updateStatus('authServiceStatus', 'Failed to load ‚ùå', 'error');
                }
            };
            
            checkLoop();
        }

        // Manual test functions
        function checkGoogleAPI() {
            if (typeof gapi !== 'undefined') {
                log('‚úì Google API is available');
                if (gapi.auth2) {
                    log('‚úì Google Auth2 is loaded');
                    const authInstance = gapi.auth2.getAuthInstance();
                    if (authInstance) {
                        log('‚úì Auth instance exists');
                        log(`Current signed-in status: ${authInstance.isSignedIn.get()}`);
                    } else {
                        log('‚ùå Auth instance not found');
                    }
                } else {
                    log('‚ùå Google Auth2 not loaded');
                }
            } else {
                log('‚ùå Google API not available');
            }
        }

        function checkAuthService() {
            if (typeof googleAuthService !== 'undefined') {
                log('‚úì Auth Service is available');
                log(`Initialized: ${googleAuthService.isInitialized}`);
                log(`Signed in: ${googleAuthService.isSignedIn()}`);
                if (googleAuthService.isSignedIn()) {
                    const userInfo = googleAuthService.getUserInfo();
                    log(`User: ${userInfo?.name} (${userInfo?.email})`);
                }
            } else {
                log('‚ùå Auth Service not available');
            }
        }

        function testNetworkConnection() {
            log('Testing network connection...');
            
            // Test loading Google API script
            fetch('https://apis.google.com/js/api.js')
                .then(() => log('‚úì Can reach Google APIs'))
                .catch(error => log(`‚ùå Cannot reach Google APIs: ${error.message}`));
                
            // Test basic internet connection
            fetch('https://www.google.com', { mode: 'no-cors' })
                .then(() => log('‚úì Internet connection working'))
                .catch(error => log(`‚ùå No internet connection: ${error.message}`));
        }

        function clearConsole() {
            console.clear();
            document.getElementById('statusLog').textContent = '';
            logCounter = 0;
            log('Console cleared');
        }

        // Test authentication functions
        async function testSignIn() {
            try {
                log('Attempting to sign in...');
                if (typeof googleAuthService === 'undefined') {
                    throw new Error('Auth service not available');
                }
                
                if (!googleAuthService.isInitialized) {
                    throw new Error('Auth service not initialized');
                }
                
                const user = await googleAuthService.signIn();
                log('‚úì Sign in successful');
                updateUI();
            } catch (error) {
                log(`‚ùå Sign in failed: ${error.message}`);
                updateStatus('authStatus', `Sign in failed: ${error.message}`, 'error');
            }
        }

        async function testSignOut() {
            try {
                log('Attempting to sign out...');
                await googleAuthService.signOut();
                log('‚úì Sign out successful');
                updateUI();
            } catch (error) {
                log(`‚ùå Sign out failed: ${error.message}`);
            }
        }

        function updateUI() {
            if (typeof googleAuthService !== 'undefined' && googleAuthService.isSignedIn()) {
                const userInfo = googleAuthService.getUserInfo();
                
                document.getElementById('googleSignInBtn').style.display = 'none';
                document.getElementById('userProfile').style.display = 'block';
                
                document.getElementById('userAvatar').src = userInfo.picture;
                document.getElementById('userName').textContent = userInfo.name;
                document.getElementById('userEmail').textContent = userInfo.email;
                
                updateStatus('authStatus', `Signed in as ${userInfo.name}`, 'success');
                log(`‚úì UI updated for user: ${userInfo.name}`);
            } else {
                document.getElementById('googleSignInBtn').style.display = 'inline-flex';
                document.getElementById('userProfile').style.display = 'none';
                
                updateStatus('authStatus', 'Not signed in', 'info');
                log('UI updated for signed-out state');
            }
        }
    </script>
</body>
</html>
